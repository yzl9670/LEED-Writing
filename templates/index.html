<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LEED Rubrics Display</title>
    <style>
        /* 基础样式 */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .main-container {
            display: flex;
            flex: 1;
            height: 100%;
        }
        .left-menu {
            width: 0; /* 隐藏左侧菜单 */
            background-color: #4a76a8;
            color: #fff;
            padding: 0; /* 隐藏左侧菜单 */
            display: none; /* 隐藏左侧菜单 */
            flex-direction: column;
            gap: 20px;
        }
        .content {
            width: 80%; /* 调整宽度 */
            padding: 20px;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            background-color: #e9ecef;
            padding: 20px;
            padding-bottom: 80px;
            border-radius: 10px;
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            max-width: 70%;
            word-wrap: break-word;
            position: relative;
        }
        .chat-message.user {
            background-color: #d1e7dd;
            align-self: flex-end;
        }
        .chat-message.ai {
            background-color: #d0e2f2;
            align-self: flex-start;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .input-container {
            display: flex;
            gap: 10px;
            align-items: center;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            padding: 10px 0;
            z-index: 2;
        }
        .input-container textarea {
            flex-grow: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: none;
            min-height: 50px;
            max-height: 50%;
            overflow-y: auto;
        }
        .input-container button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        /* 上传按钮样式 */
        .upload-button {
            position: relative;
            overflow: hidden;
            display: inline-block;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .upload-button input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        .rubrics-container {
            width: 20%;
            padding: 20px;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }
        .rubrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        .rubrics-header h3 {
            margin: 0;
        }
        .actions {
            display: flex;
            gap: 10px;
        }
        .rubrics-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            max-height: 80vh; /* 根据需要调整最大高度 */
        }
        .rubrics-list div {
            padding: 10px;
            background-color: #fafafa;
            border-radius: 5px;
            display: flex;
            align-items: flex-start;
            border: 1px solid #ddd;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .rubrics-list textarea {
            flex-grow: 1;
            padding: 10px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            resize: none;
            overflow-y: hidden;
            min-height: 50px;
            margin-right: 10px;
            background-color: transparent;
        }
        .rubrics-list textarea:focus {
            outline: none;
        }
        .rubric-button {
            padding: 5px 10px;
            font-size: 16px;
            border: none;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            cursor: pointer;
        }
        .rubric-button:hover {
            background-color: #c0392b;
        }
        /* 文件输入框样式 */
        #file-input {
            display: none;
        }
        /* 反馈面板样式 */
        .feedback-panel {
            position: absolute;
            bottom: 0;
            left: calc(100% + 10px);
            width: 175px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            z-index: 100;
        }
        .feedback-panel h4 {
            margin-top: 0;
        }
        .feedback-panel .close-button {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 18px;
            background: none;
            border: none;
            cursor: pointer;
            color: #888;
        }
        .feedback-panel .stars {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        .feedback-panel .stars span {
            font-size: 24px;
            cursor: pointer;
            color: #ccc;
        }
        .feedback-panel .stars span.selected {
            color: gold;
        }
        .feedback-panel textarea {
            width: 100%;
            resize: vertical;
            min-height: 50px;
            margin-top: 10px;
        }
        .feedback-panel button.submit-feedback {
            margin-top: 10px;
            padding: 5px 10px;
            font-size: 14px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        /* 反馈按钮样式 */
        .feedback-button {
            margin-top: 10px;
            align-self: flex-end;
            font-size: 12px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
        }
        /* LEED 页面样式 */
        #leed-page {
            display: none;
            flex-direction: column;
            flex: 1;
        }
        #leed-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        #leed-table-container {
            max-height: 60vh;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        #leed-table {
            width: 100%;
            border-collapse: collapse;
        }
        #leed-table th, #leed-table td {
            border: 1px solid #ccc;
            padding: 5px;
            text-align: left;
        }
        #leed-table th {
            background-color: #e9ecef;
        }
        #leed-table .section-header {
            background-color: #d0e2f2;
            font-weight: bold;
        }
        #leed-table input[type="number"] {
            width: 80px;
        }
        /* 按钮容器样式 */
        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        /* 只读的 textarea 样式 */
        .rubrics-list textarea[readonly] {
            background-color: transparent;
            cursor: default;
        }
        /* 拖拽上传文件的样式 */
        .chat-container.dragover {
            background-color: #c8e6c9;
        }
        /* Rubric 项目样式 */
        .rubric-item {
            width: 95%;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: block;
        }
        .rubric-title {
            font-weight: bold;
            cursor: pointer;
            padding: 10px;
            background-color: #f4f4f4;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            width: 90%;
            position: relative;
        }
        .rubric-title .title-text {
            flex-grow: 1;
        }
        .rubric-title .rubric-score {
            margin-left: 10px;
        }
        .rubric-content {
            display: none;
            flex-direction: column;
            padding: 0;
            background-color: #fff;
            border-top: 1px solid #ddd;
            width: 100%;
            box-sizing: border-box;
        }
        .rubric-content.visible {
            display: block;
        }
        /* 提示信息样式 */
        .message {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .message.red {
            color: red;
        }
        .message.green {
            color: green;
        }
        /* 更新的评分标准项样式 */
        .rubric-criteria-item {
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
        }
        .rubric-criteria-item div {
            margin-bottom: 5px;
        }
        .rubric-subcontent {
            padding: 10px 20px;
            margin: 0;
            background-color: #fff;
            border-left: 3px solid #ccc;
            display: none;
            width: 100%;
            box-sizing: border-box;
            /* 新增 */
            display: flex;
            flex-direction: column;
        }
        .rubric-subcontent.visible {
            display: flex;
        }
        .rubric-subtitle {
            font-weight: bold;
            cursor: pointer;
            padding: 10px;
            margin: 0;
            background-color: #f9f9f9;
            position: relative;
        }
        .rubric-subtitle::after {
            content: '\25BA'; /* 右箭头 */
            position: absolute;
            right: 10px;
            transition: transform 0.3s;
        }
        .rubric-subtitle.expanded::after {
            transform: rotate(90deg); /* 展开时箭头旋转 */
        }
        /* 新增的样式，用于显示评分 */
        .rubric-score {
            font-weight: bold;
            color: #007BFF;
        }
        /* 新增的样式，用于右侧总分标题 */
        .rubrics-total-score {
            font-weight: bold;
            margin-top: 10px;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .leed-rubric-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            position: relative; /* 为了定位按钮 */
        }
        /* Resubmit 按钮样式 */
        .resubmit-button {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 12px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
        }
        .resubmit-button:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body>
    <div class="main-container" id="main-container">
        <!-- 左侧按钮部分（已隐藏） -->
        <div class="left-menu">
            <!-- 左侧菜单已隐藏 -->
        </div>

        <!-- 中间聊天内容部分 -->
        <div class="content">
            <div class="chat-container" id="chat-container">
                <div class="chat-message ai">Welcome to the AI feedback system!</div>
            </div>
            <div class="input-container">
                <!-- 美化的上传按钮 -->
                <label class="upload-button">
                    Upload
                    <input type="file" id="file-input" accept=".docx,.pdf" onchange="sendMessage()">
                </label>
                <textarea id="user-input" placeholder="Type your message here..." oninput="autoResizeTextarea(this)"></textarea>
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>

        <!-- 右侧 Rubrics 管理部分 -->
        <div class="rubrics-container" id="rubrics-container">
            <!-- LEED Rubric 总标题和总分显示 -->
            <div class="leed-rubric-header" id="leed-rubric-header">
                LEED Narrative Assignment Rubric
                <!-- Resubmit 按钮 -->
                <button class="resubmit-button" onclick="resubmitLeed()">Resubmit LEED</button>
            </div>
            <div class="rubrics-total-score" id="rubrics-total-score">
                Total Score: 0/15
            </div>
            <!-- LEED Rubrics List -->
            <div class="rubrics-list" id="leed-rubrics-list">
                <!-- LEED rubrics will be populated here -->
            </div>
        </div>
    </div>

    <!-- LEED 页面 -->
    <div id="leed-page" class="main-container">
        <!-- LEED 表格内容 -->
        <div class="content" id="leed-content">
            <h2>LEED Certification Form</h2>
            <div id="leed-table-container">
                <form id="leed-form">
                    <!-- LEED 表格将在此生成 -->
                    <table id="leed-table">
                        <!-- 表头 -->
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Prereq/Credit</th>
                                <th>Title</th>
                                <th>Points</th>
                                <th>Earned</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 表格内容将在 JavaScript 中生成 -->
                        </tbody>
                    </table>
                </form>
            </div>
            <!-- 按钮容器 -->
            <div class="button-container">
                <button class="back-button" onclick="returnToMain()">Back</button>
                <button id="leed-submit-button" onclick="submitLeedForm()">Submit LEED Scores</button>
            </div>
        </div>
    </div>

    <script>
        let currentChatHistoryId = null;  // 当前正在反馈的聊天记录ID
        let currentMode = 'LEED'; // 默认模式改为 'LEED'

        // 自动调整输入框高度
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, window.innerHeight * 0.5) + 'px';
        }

        // 获取当前的 Rubrics（仅在 Writing 模式下）
        function getCurrentRubrics() {
            const rubricsList = document.getElementById('writing-rubrics-list');
            const rubricTextareas = rubricsList.querySelectorAll('textarea');
            let rubrics = '';
            rubricTextareas.forEach(textarea => {
                rubrics += textarea.value + '\n\n';
            });
            return rubrics.trim();
        }

        // 发送消息到聊天窗口，并将 Rubrics 一起发送到后端
        function sendMessage() {
            const input = document.getElementById('user-input');
            const fileInput = document.getElementById('file-input');
            const message = input.value;
            const file = fileInput.files[0];

            if (!message.trim() && !file) {
                alert("Please enter a message or upload a file.");
                return;
            }

            const formData = new FormData();
            formData.append('message', message);

            if (currentMode === 'LEED') {
                const leedScores = JSON.parse(sessionStorage.getItem('leedScores'));
                if (leedScores) {
                    formData.append('leed_scores', JSON.stringify(leedScores));
                } else {
                    alert('Please submit LEED scores first.');
                    return;
                }
            } else {
                const rubrics = getCurrentRubrics();
                formData.append('rubrics', rubrics);
            }

            if (file) {
                console.log('Selected file:', file);
                formData.append('file', file);
            } else {
                console.log('No file selected.');
            }
            
            // 打印 FormData 的内容
            for (let pair of formData.entries()) {
                console.log(pair[0]+ ', ' + pair[1]);
            }
            
            // 将用户输入的消息和 Rubrics 发送到后端
            fetch('/get_feedback', {
                method: 'POST',
                body: formData,
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success === false) {
                    alert(data.error);
                    return;
                }
                const chatContainer = document.getElementById('chat-container');

                // 显示用户消息
                if (message.trim()) {
                    const userMessageElem = document.createElement('div');
                    userMessageElem.classList.add('chat-message', 'user');
                    userMessageElem.textContent = message;
                    chatContainer.appendChild(userMessageElem);
                } else if (file) {
                    const userMessageElem = document.createElement('div');
                    userMessageElem.classList.add('chat-message', 'user');
                    userMessageElem.textContent = `Uploaded file: ${file.name}`;
                    chatContainer.appendChild(userMessageElem);
                }

                // 显示 AI 反馈
                const aiMessageElem = document.createElement('div');
                aiMessageElem.classList.add('chat-message', 'ai');

                // 创建内容容器，避免 Feedback 按钮遮挡内容
                const aiContent = document.createElement('div');
                aiContent.textContent = data.feedback;
                aiMessageElem.appendChild(aiContent);

                // 添加反馈按钮
                const feedbackBtn = document.createElement('button');
                feedbackBtn.classList.add('feedback-button');
                feedbackBtn.textContent = 'Feedback';
                feedbackBtn.onclick = function() {
                    toggleFeedbackPanel(aiMessageElem, data.chat_history_id, feedbackBtn);
                };
                aiMessageElem.appendChild(feedbackBtn);

                chatContainer.appendChild(aiMessageElem);

                // 重置输入框和文件输入
                input.value = '';
                input.style.height = '50px';
                fileInput.value = '';
                chatContainer.scrollTop = chatContainer.scrollHeight;

                // 更新 Rubrics 的评分显示
                if (currentMode === 'LEED') {
                    updateLeedRubricScores(data.scores);
                } else {
                    updateWritingRubricScores(data.scores);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while processing your request.');
            });
        }

        // 更新 LEED Rubrics 的评分
        function updateLeedRubricScores(scores) {
            const rubricsList = document.getElementById('leed-rubrics-list');
            const rubricItems = rubricsList.querySelectorAll('.rubric-item');

            let totalScore = 0; // 用于计算总分
            let totalPossibleScore = 0; // 用于计算总可能得分

            rubricItems.forEach(rubricElem => {
                const titleElem = rubricElem.querySelector('.rubric-title');
                const rubricName = titleElem.getAttribute('data-rubric-name');

                if (scores && scores[rubricName]) {
                    let scoreElem = titleElem.querySelector('.rubric-score');
                    if (!scoreElem) {
                        scoreElem = document.createElement('span');
                        scoreElem.classList.add('rubric-score');
                        titleElem.appendChild(scoreElem);
                    }
                    scoreElem.textContent = `Score: ${scores[rubricName].score}/${scores[rubricName].total}`;

                    // 累加总分
                    totalScore += scores[rubricName].score;
                    totalPossibleScore += scores[rubricName].total;
                }
            });

            // 更新总分显示
            const totalScoreElem = document.getElementById('rubrics-total-score');
            totalScoreElem.textContent = `Total Score: ${totalScore}/15`;

            displayScoreMessage(totalScore);
        }

        function displayScoreMessage(totalScore) {
            let messageElem = document.getElementById('leed-score-message');
            if (!messageElem) {
                // 创建提示信息元素
                messageElem = document.createElement('div');
                messageElem.id = 'leed-score-message';
                messageElem.style.fontWeight = 'bold';
                messageElem.style.marginTop = '10px';
                messageElem.style.textAlign = 'center';
                document.getElementById('rubrics-container').appendChild(messageElem);
            }
        
            if (totalScore >= 40) {
                messageElem.textContent = `Congratulations! Your total LEED score is ${totalScore}, which meets the minimum requirement for LEED certification.`;
                messageElem.style.color = 'green';
            } else {
                messageElem.textContent = `Your total LEED score is ${totalScore}. You need at least 40 points to achieve LEED certification.`;
                messageElem.style.color = 'red';
            }
            const headerElem = document.getElementById('leed-rubric-header');
            const totalScoreElem = document.getElementById('rubrics-total-score');

            if (headerElem && totalScoreElem) {
                if (messageElem.parentNode !== headerElem.parentNode || messageElem.nextSibling !== totalScoreElem) {
                    headerElem.parentNode.insertBefore(messageElem, totalScoreElem);
                }
            }
        }

        // 更新 Writing Rubrics 的评分
        function updateWritingRubricScores(scores) {
            const rubricsList = document.getElementById('writing-rubrics-list');
            const rubricItems = rubricsList.querySelectorAll('.rubric-item');

            rubricItems.forEach(rubricElem => {
                const textarea = rubricElem.querySelector('textarea');
                const rubricName = textarea.getAttribute('data-rubric-name');

                if (scores && scores[rubricName]) {
                    let scoreElem = rubricElem.querySelector('.rubric-score');
                    if (!scoreElem) {
                        scoreElem = document.createElement('span');
                        scoreElem.classList.add('rubric-score');
                        rubricElem.appendChild(scoreElem);
                    }
                    scoreElem.textContent = `Score: ${scores[rubricName].score}/${scores[rubricName].total}`;
                }
            });
        }

        // 切换反馈面板的显示
        function toggleFeedbackPanel(aiMessageElem, chatHistoryId, feedbackBtn) {
            let feedbackPanel = aiMessageElem.querySelector('.feedback-panel');
            if (feedbackPanel) {
                feedbackPanel.remove();
            } else {
                feedbackPanel = document.createElement('div');
                feedbackPanel.classList.add('feedback-panel');

                // 关闭按钮
                const closeButton = document.createElement('button');
                closeButton.classList.add('close-button');
                closeButton.innerHTML = '&times;';
                closeButton.onclick = function() {
                    feedbackPanel.remove();
                };
                feedbackPanel.appendChild(closeButton);

                const title = document.createElement('h4');
                title.textContent = 'How do you like this response?';
                feedbackPanel.appendChild(title);

                // 星级评分
                const starsDiv = document.createElement('div');
                starsDiv.classList.add('stars');
                for (let i = 1; i <= 5; i++) {
                    const starSpan = document.createElement('span');
                    starSpan.textContent = '★';
                    starSpan.dataset.value = i;
                    starSpan.onclick = function() {
                        selectStars(starsDiv, i);
                    };
                    starsDiv.appendChild(starSpan);
                }
                feedbackPanel.appendChild(starsDiv);

                // 反馈文本框
                const feedbackTextarea = document.createElement('textarea');
                feedbackTextarea.placeholder = 'Enter your feedback...';
                feedbackPanel.appendChild(feedbackTextarea);

                // 提交按钮
                const submitButton = document.createElement('button');
                submitButton.classList.add('submit-feedback');
                submitButton.textContent = 'Submit';
                submitButton.onclick = function() {
                    submitFeedback(chatHistoryId, getSelectedStars(starsDiv), feedbackTextarea.value);
                    feedbackPanel.remove();
                    feedbackBtn.style.display = 'none';
                };
                feedbackPanel.appendChild(submitButton);

                aiMessageElem.appendChild(feedbackPanel);

                // 检查反馈面板是否超出可视区域，调整位置
                const rect = feedbackPanel.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    feedbackPanel.style.left = 'auto';
                    feedbackPanel.style.right = 'calc(100% + 10px)';
                }
            }
        }

        // 选择星星评分
        function selectStars(starsDiv, rating) {
            const stars = starsDiv.querySelectorAll('span');
            stars.forEach(star => {
                if (parseInt(star.dataset.value) <= rating) {
                    star.classList.add('selected');
                } else {
                    star.classList.remove('selected');
                }
            });
        }

        // 获取选中的星星数
        function getSelectedStars(starsDiv) {
            const selectedStars = starsDiv.querySelectorAll('span.selected');
            return selectedStars.length;
        }

        // 提交用户对 AI 回复的反馈
        function submitFeedback(chatHistoryId, rating, feedback) {
            fetch('/submit_feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    chat_history_id: chatHistoryId,
                    rating: rating,
                    feedback: feedback
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Thank you for your feedback!');
                } else {
                    alert('Failed to submit feedback: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while submitting your feedback.');
            });
        }

        // 显示 LEED Rubrics
        function displayLeedRubrics(rubrics) {
            const rubricsList = document.getElementById('leed-rubrics-list');
            rubricsList.innerHTML = ''; // 清空之前的内容

            rubrics.forEach(rubricData => {
                const rubricElem = document.createElement('div');
                rubricElem.classList.add('rubric-item');
                rubricElem.style.display = 'block';  // 强制垂直排列

                // 主标题元素，显示名称
                const titleElem = document.createElement('div');
                titleElem.classList.add('rubric-title');
                // 添加 data-rubric-name 属性
                titleElem.setAttribute('data-rubric-name', rubricData.name);

                // 创建标题文本
                const titleTextElem = document.createElement('span');
                titleTextElem.classList.add('title-text');
                titleTextElem.textContent = `${rubricData.name}`;

                // 将评分显示添加到标题元素
                const scoreElem = document.createElement('span');
                scoreElem.classList.add('rubric-score');
                scoreElem.textContent = 'Score: 0/0'; // 初始分数

                // 将标题文本和评分添加到标题元素
                titleElem.appendChild(titleTextElem);
                titleElem.appendChild(scoreElem);

                // 内容容器
                const contentElem = document.createElement('div');
                contentElem.classList.add('rubric-content');
                contentElem.style.display = 'none'; // 初始隐藏

                // 评分标准内容
                const criteriaContentElem = document.createElement('div');
                criteriaContentElem.classList.add('rubric-subcontent');

                // 显示评分标准
                if (Array.isArray(rubricData.scoringCriteria) && rubricData.scoringCriteria.length > 0) {
                    rubricData.scoringCriteria.forEach(criteria => {
                        const criteriaItemElem = document.createElement('div');
                        criteriaItemElem.classList.add('rubric-criteria-item');

                        const criteriaItemTitle = document.createElement('div');
                        criteriaItemTitle.textContent = `${criteria.points} Points`;
                        criteriaItemTitle.style.fontWeight = 'bold';

                        const criteriaItemContent = document.createElement('div');
                        criteriaItemContent.textContent = `${criteria.description}`;

                        criteriaItemElem.appendChild(criteriaItemTitle);
                        criteriaItemElem.appendChild(criteriaItemContent);

                        criteriaContentElem.appendChild(criteriaItemElem);
                    });
                } else {
                    criteriaContentElem.textContent = 'No scoring criteria available.';
                }

                // 点击标题，展开/收起内容
                titleElem.addEventListener('click', function() {
                    if (contentElem.style.display === 'none') {
                        contentElem.style.display = 'block';
                        titleElem.classList.add('expanded');
                    } else {
                        contentElem.style.display = 'none';
                        titleElem.classList.remove('expanded');
                    }
                });

                // 组装内容
                contentElem.appendChild(criteriaContentElem);

                // 将标题和内容添加到 Rubric 元素
                rubricElem.appendChild(titleElem);
                rubricElem.appendChild(contentElem);

                // 添加到 Rubrics 列表
                rubricsList.appendChild(rubricElem);
            });
        }

        // 页面加载时
        window.onload = function() {
            // 默认进入 LEED 模式并显示 LEED 页面
            currentMode = 'LEED';

            // 显示 LEED Rubrics
            document.getElementById('leed-rubric-header').style.display = 'flex';
            document.getElementById('leed-rubrics-list').style.display = 'flex';

            // 检查用户是否已经提交了 LEED Scores
            if (sessionStorage.getItem('leedSubmitted') === 'true') {
                // 加载并显示 LEED Rubrics
                displayLeedRubrics(LEED_RUBRIC);
                const totalScore = parseFloat(sessionStorage.getItem('leedTotalScore')) || 0;
        displayScoreMessage(totalScore);
            } else {
                showLeedPage();
            }

            // 初始化拖拽上传文件功能
            initDragAndDrop();
        }

        // 显示 LEED 页面
        function showLeedPage() {
            // 隐藏主界面，显示 LEED 页面
            document.getElementById('main-container').style.display = 'none';
            document.getElementById('leed-page').style.display = 'flex';

            // 生成 LEED 表格
            generateLeedTable();

            // 如果已填写过数据，填充表格
            const leedScores = JSON.parse(sessionStorage.getItem('leedScores') || '{}');
            if (Object.keys(leedScores).length > 0) {
                fillLeedForm(leedScores);
            }
        }

        // 填充 LEED 表格
        function fillLeedForm(leedScores) {
            const form = document.getElementById('leed-form');
            for (let [key, value] of Object.entries(leedScores)) {
                const input = form.querySelector(`input[name="${key}"]`);
                if (input) {
                    input.value = value;
                }
            }
        }

        // 返回主界面
        function returnToMain() {
            // 显示主界面，隐藏 LEED 页面
            document.getElementById('main-container').style.display = 'flex';
            document.getElementById('leed-page').style.display = 'none';

            // 显示 LEED Rubrics
            document.getElementById('leed-rubric-header').style.display = 'flex';
            document.getElementById('leed-rubrics-list').style.display = 'flex';
        }

        // 生成 LEED 表格
        function generateLeedTable() {
            const tbody = document.querySelector('#leed-table tbody');
            tbody.innerHTML = '';

            LEED_TABLE_DATA.forEach(section => {
                // 添加章节标题
                const sectionHeader = document.createElement('tr');
                sectionHeader.classList.add('section-header');
                const sectionTd = document.createElement('td');
                sectionTd.colSpan = '5';
                sectionTd.textContent = section.section;
                sectionHeader.appendChild(sectionTd);
                tbody.appendChild(sectionHeader);

                // 遍历章节下的项目
                section.items.forEach(item => {
                    const tr = document.createElement('tr');

                    const tdCategory = document.createElement('td');
                    tdCategory.textContent = section.section || '';
                    tr.appendChild(tdCategory);

                    const tdType = document.createElement('td');
                    tdType.textContent = item.type || '';
                    tr.appendChild(tdType);

                    const tdTitle = document.createElement('td');
                    tdTitle.textContent = item.name || '';
                    tr.appendChild(tdTitle);

                    const tdPoints = document.createElement('td');
                    let pointsDisplay;

                    // 判断是否为必需项
                    if (item.type && item.type.toLowerCase() === 'prereq') {
                        pointsDisplay = 'Required';
                    } else {
                        pointsDisplay = getMaxPoints(item.points);
                        // 如果 pointsDisplay 为 '0'，则设置为 'Required'
                        if (pointsDisplay === '0') {
                            pointsDisplay = 'Required';
                        }
                    }

                    tdPoints.textContent = pointsDisplay;
                    tr.appendChild(tdPoints);

                    const tdEarned = document.createElement('td');
                    // 修改这里：根据 pointsDisplay 是否为 'Required' 来决定显示 'Required' 或输入框
                    if (pointsDisplay === 'Required') {
                        tdEarned.textContent = 'Required';
                    } else if (pointsDisplay) {
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.name = item.name;
                        input.min = 0;
                        input.max = parseFloat(pointsDisplay);
                        input.step = 0.5;
                        tdEarned.appendChild(input);

                        // 如果之前用户已经输入了分数，填充到输入框中
                        const savedLeedScores = JSON.parse(sessionStorage.getItem('leedScores') || '{}');
                        if (input && savedLeedScores[item.name] !== undefined) {
                            input.value = savedLeedScores[item.name];
                        }
                    } else {
                        tdEarned.textContent = '';
                    }
                    tr.appendChild(tdEarned);

                    tbody.appendChild(tr);
                });
            });
        }

        // 新增的 getMaxPoints 函数，用于获取最大分数
        function getMaxPoints(points) {
            if (typeof points === 'number') {
                return points.toString();
            } else if (Array.isArray(points)) {
                return Math.max(...points).toString();
            } else if (typeof points === 'object' && points !== null) {
                // 提取所有数字点值，展开数组
                let pointValues = [];
                Object.values(points).forEach(val => {
                    if (Array.isArray(val)) {
                        pointValues = pointValues.concat(val);
                    } else if (typeof val === 'number') {
                        pointValues.push(val);
                    }
                });
                // 移除重复值
                pointValues = [...new Set(pointValues)];
                if (pointValues.length === 0) {
                    return '';
                }
                return Math.max(...pointValues).toString();
            }
            return '';
        }

        // 提交 LEED 表格
        function submitLeedForm() {
            const form = document.getElementById('leed-form');
            const formData = new FormData(form);

            const leedScores = {};
            let totalScore = 0;

            for (let [key, value] of formData.entries()) {
                if (value && !isNaN(parseFloat(value))) {
                    leedScores[key] = parseFloat(value);
                    totalScore += parseFloat(value);
                }
            }

            if (Object.keys(leedScores).length === 0) {
                alert('Please enter at least one score.');
                return;
            }

            displayScoreMessage(totalScore);

            // 将用户输入的分数发送到后端
            fetch('/submit_leed_scores', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ leed_scores: leedScores })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    sessionStorage.setItem('leedSubmitted', 'true');
                    sessionStorage.setItem('leedScores', JSON.stringify(leedScores));
                    sessionStorage.setItem('leedTotalScore', totalScore);

                    returnToMain();

                    // 加载并显示 LEED Rubrics
                    displayLeedRubrics(LEED_RUBRIC);

                } else {
                    alert('Failed to submit LEED scores: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while submitting LEED scores.');
            });
        }

        // 重新提交 LEED 表格
        function resubmitLeed() {
            // 清除 LEED 数据
            sessionStorage.removeItem('leedSubmitted');
            sessionStorage.removeItem('leedScores');
            sessionStorage.removeItem('leedTotalScore');

            // 显示 LEED 表格页面
            showLeedPage();
        }

        // 初始化拖拽上传文件功能
        function initDragAndDrop() {
            const chatContainer = document.getElementById('chat-container');
            const fileInput = document.getElementById('file-input');

            chatContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                chatContainer.classList.add('dragover');
            });

            chatContainer.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                chatContainer.classList.remove('dragover');
            });

            chatContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                chatContainer.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    sendMessage();
                }
            });
        }

        // 加载 LEED 数据
        const LEED_TABLE_DATA = {{ leed_table_data|tojson|safe }};

        // 新的 LEED Rubric 数据
        const LEED_RUBRIC = [
            {
                name: 'LEED Certification Achievement',
                scoringCriteria: [
                    {
                        points: 3,
                        description: 'The narrative clearly demonstrates that the project achieves at least LEED Certified status (40-49 points). This includes selecting the necessary credits and meeting all prerequisite requirements as outlined in LEED v4 BD+C. The student’s narrative must show that the combination of credits chosen would, in reality, enable the project to achieve certification, with no missing or misinterpreted prerequisites or credits.'
                    },
                    {
                        points: 2,
                        description: 'The project demonstrates an effort to achieve LEED certification but falls short of meeting all the prerequisite credits or does not fully align the credit selection with the required number of points for certification. There may be minor misunderstandings about specific credit requirements or a lack of clarity about how the project will meet the minimum certification threshold.'
                    },
                    {
                        points: 1,
                        description: 'The project fails to adequately address key LEED prerequisites or selected credits are significantly misaligned with achieving certification. It may attempt to claim certification without showing how the credit requirements are realistically met.'
                    },
                    {
                        points: 0,
                        description: 'The narrative does not address how the project will achieve LEED certification, or no credit selections are provided.'
                    }
                ]
            },
            {
                name: 'Reflection of Credit Requirements',
                scoringCriteria: [
                    {
                        points: 4,
                        description: 'The narrative must accurately reflect the specific requirements for each credit selected, including the minimum thresholds, performance metrics, and technical criteria as outlined in LEED v4 BD+C. For example, if the student claims points for Water Efficiency, the narrative should describe how the project meets the exact reductions in water use required for the chosen credit level. Each credit should be fully justified with a clear explanation of how the project meets all quantifiable and qualitative requirements necessary to claim the credit’s points.'
                    },
                    {
                        points: 3,
                        description: 'Most credit requirements are correctly identified and explained, though some credits may lack the level of detail needed to fully demonstrate compliance with LEED standards. There may be minor misinterpretations of the performance thresholds or metrics for a few credits.'
                    },
                    {
                        points: 2,
                        description: 'Several credit requirements are not adequately reflected, with important aspects of LEED compliance misunderstood or missing. The narrative may generalize credit requirements rather than explaining how the specific thresholds or criteria are met.'
                    },
                    {
                        points: 1,
                        description: 'The narrative mentions credits but provides little to no explanation of how the project will meet the detailed requirements. The understanding of LEED requirements is either vague or incorrect.'
                    },
                    {
                        points: 0,
                        description: 'The narrative does not reflect any LEED credit requirements, or no credits are discussed.'
                    }
                ]
            },
            {
                name: 'Formatting: Credit Names and Points Claimed',
                scoringCriteria: [
                    {
                        points: 3,
                        description: 'The narrative must clearly list the name of each credit pursued and the points claimed for each one, following the LEED v4 BD+C structure. The credit names should be accurately listed as they appear in the LEED reference guide, and the corresponding points should reflect the exact level claimed based on the project\'s anticipated performance (e.g., low, medium, or high point tiers for Energy Performance). The formatting should make it easy to identify each credit and its associated points within the narrative.'
                    },
                    {
                        points: 2,
                        description: 'Most credits are clearly named and points claimed, but there may be some minor inconsistencies in how credits or point totals are presented. Formatting may require some clarification but still allows the reader to generally follow the credit selection.'
                    },
                    {
                        points: 1,
                        description: 'The credit names or points claimed are incomplete or inconsistent, making it difficult to understand which credits are being pursued or how many points the student aims to achieve. The formatting lacks clarity, and important details are missing.'
                    },
                    {
                        points: 0,
                        description: 'No credit names or points claimed are provided, or the formatting is so unclear that it is difficult to determine which credits are being pursued.'
                    }
                ]
            },
            {
                name: 'Realistic and Detailed Implementation of Credits',
                scoringCriteria: [
                    {
                        points: 3,
                        description: 'The narrative must provide a realistic and detailed explanation of how the project will achieve each credit selected. The explanation should not only outline general strategies but also address specific technical requirements, such as system performance, material selections, or site strategies that align with LEED’s detailed credit standards. For instance, if claiming points for Indoor Environmental Quality, the student should specify exactly how ventilation, material off-gassing limits, or lighting controls will meet LEED thresholds.'
                    },
                    {
                        points: 2,
                        description: 'The narrative provides a generally realistic description of how credits will be achieved but lacks some depth in the technical or detailed aspects. Some strategies may be too general or not fully aligned with LEED’s specific performance or compliance standards.'
                    },
                    {
                        points: 1,
                        description: 'The explanation of how credits will be achieved is vague or unrealistic, with minimal attention to the detailed requirements necessary for LEED compliance. The strategies may be impractical for the project\'s scope.'
                    },
                    {
                        points: 0,
                        description: 'The student does not provide any realistic strategies for achieving the credits, or no explanation is provided.'
                    }
                ]
            },
            {
                name: 'Grammar, Structure, and Clarity',
                scoringCriteria: [
                    {
                        points: 2,
                        description: 'The narrative is clearly written, well-organized, and free of significant grammatical or spelling errors. The structure is logical, with headings and subheadings that make it easy to navigate through the different credits and their explanations. The use of technical language is appropriate, and the narrative maintains a professional tone throughout.'
                    },
                    {
                        points: 1.5,
                        description: 'The narrative is mostly well-written and organized, but may contain a few minor grammatical or structural issues. Headings and subheadings are generally used but may not always be clear or consistent.'
                    },
                    {
                        points: 1,
                        description: 'The narrative contains several grammatical or structural errors that impact readability. The organization is somewhat unclear, and the structure of the document may be confusing or inconsistent.'
                    },
                    {
                        points: 0,
                        description: 'The narrative is poorly written, difficult to follow, and lacks organization. Grammar and spelling errors significantly impair the reader’s ability to understand the content.'
                    }
                ]
            }
        ];

    </script>
</body>
</html>
